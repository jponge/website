<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Not all Java single-threaded executors are created equal: a Java finalizer horror story | Julien Ponge</title>
<meta name="generator" content="Jekyll v4.0.1" />
<meta property="og:title" content="Not all Java single-threaded executors are created equal: a Java finalizer horror story" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I was recently puzzled by flaky tests in Mutiny." />
<meta property="og:description" content="I was recently puzzled by flaky tests in Mutiny." />
<link rel="canonical" href="https://julien.ponge.org/blog/not-all-java-single-threaded-executors-are-created-equal-a-java-finalizer-horror-story/" />
<meta property="og:url" content="https://julien.ponge.org/blog/not-all-java-single-threaded-executors-are-created-equal-a-java-finalizer-horror-story/" />
<meta property="og:site_name" content="Julien Ponge" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-12-02T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Not all Java single-threaded executors are created equal: a Java finalizer horror story" />
<script type="application/ld+json">
{"headline":"Not all Java single-threaded executors are created equal: a Java finalizer horror story","dateModified":"2021-12-02T00:00:00+01:00","datePublished":"2021-12-02T00:00:00+01:00","url":"https://julien.ponge.org/blog/not-all-java-single-threaded-executors-are-created-equal-a-java-finalizer-horror-story/","mainEntityOfPage":{"@type":"WebPage","@id":"https://julien.ponge.org/blog/not-all-java-single-threaded-executors-are-created-equal-a-java-finalizer-horror-story/"},"description":"I was recently puzzled by flaky tests in Mutiny.","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://julien.ponge.org/feed.xml" title="Julien Ponge" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Julien Ponge</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/">Blog</a><a class="page-link" href="/publications/">Publications</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Not all Java single-threaded executors are created equal: a Java finalizer horror story</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-12-02T00:00:00+01:00" itemprop="datePublished">Dec 2, 2021
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I was recently puzzled by flaky tests in <a href="https://smallrye.io/smallrye-mutiny/">Mutiny</a>.</p>

<h3 id="the-problem">The problem</h3>

<p>Once in a while we would get build failures in <em>GitHub Action</em> runners, and of course we could not reproduce them locally.
Even repeating a test a thousand times would not reproduce the failure seen in the runners.
And of course, there was not much determinism in which test could fail.</p>

<p>Still, the logs would hint at tasks being rejected by terminated Java executors, so I started digging.
I went through the usage of executors in tests, but aside from a few trivial fixes, all executors were being used as they should be, as in:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Get an executor</span>
<span class="kt">var</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>

<span class="c1">// Do stuff</span>
<span class="n">doThingsWith</span><span class="o">(</span><span class="n">executor</span><span class="o">);</span>

<span class="c1">// Shut it down</span>
<span class="n">executor</span><span class="o">.</span><span class="na">shutdownNow</span><span class="o">();</span>
</code></pre></div></div>

<h3 id="the-eureka-moment">The <a href="https://en.wikipedia.org/wiki/Eureka_(word)">Eureka</a> moment</h3>

<p>I then started tracking calls to <code class="highlighter-rouge">shutdown()</code> and <code class="highlighter-rouge">shutdownNow()</code>, to try and see if we had some code, somewhere, that would shut an executor down.
Nothing in tests, but I eventually found a call to <code class="highlighter-rouge">shutdown</code> in that class from the JDK:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="kd">class</span> <span class="nc">FinalizableDelegatedExecutorService</span>
    <span class="kd">extends</span> <span class="nc">DelegatedExecutorService</span> <span class="o">{</span>
    <span class="nc">FinalizableDelegatedExecutorService</span><span class="o">(</span><span class="nc">ExecutorService</span> <span class="n">executor</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">executor</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">finalize</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Guess what?</p>

<p>This class is used byâ€¦ <code class="highlighter-rouge">Executors.newSingleThreadExecutor()</code>!</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">ExecutorService</span> <span class="nf">newSingleThreadExecutor</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">FinalizableDelegatedExecutorService</span>
        <span class="o">(</span><span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span>
                                <span class="mi">0L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>
                                <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;()));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>So if you create an executor using <code class="highlighter-rouge">newSingleThreadExecutor()</code>, then the actual executor is being wrapped in a class whose sole purpose is to call <code class="highlighter-rouge">shutdown()</code> in a <em>finalizer</em>.</p>

<p>See the first paragraph of the documentation of the (now-deprecated!) <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Object.html#finalize()"><code class="highlighter-rouge">Object.finalize()</code> method</a>:</p>

<blockquote>
  <p>Called by the garbage collector on an object when garbage collection determines that there are no more references to the object. 
A subclass overrides the finalize method to dispose of system resources or to perform other cleanup.</p>
</blockquote>

<p>It is to be expected that in a constrained environment such as that of a CI/CD runner, the garbage collector has to run more frequently than on a 32Gb of RAM laptop.
Depending on how your code is written, you may end up in cases where an executor gets <em>finalized</em> before it has received all tasks and they get rejected.</p>

<h3 id="the-fix-and-a-bit-of-caution">The fix, and a bit of caution</h3>

<p>In the case of Mutiny tests flakiness was greatly reduced by replacing calls of:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newSingleThreadExecutor</span><span class="o">();</span>
</code></pre></div></div>

<p>with:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</code></pre></div></div>

<p>Indeed <code class="highlighter-rouge">newSingleThreadExecutor()</code> is the sole method that wraps executors with <code class="highlighter-rouge">FinalizableDelegatedExecutorService</code>.</p>

<p>Now should you do the same to your code base and ditch <code class="highlighter-rouge">newSingleThreadExecutor()</code>?</p>

<p>I donâ€™t think so!</p>

<ol>
  <li>Make sure that you manage executors <em>correctly</em>, and especially that you donâ€™t forget to shut them down.
This is especially important in test suites because you could be creating lots of them.</li>
  <li>As a general practice for new code I think itâ€™s a good idea to call <code class="highlighter-rouge">Executors.newFixedThreadPool(1)</code>, even if thereâ€™s a method with the correct name for the purpose.
At some point in future Java releases <em>finalizers</em> will be gone and <code class="highlighter-rouge">Executors.newSingleThreadExecutor()</code> will have the same runtime behavior, but meanwhile you can avoid some potential headaches.</li>
  <li>If you or your libraries use <code class="highlighter-rouge">Executors.newSingleThreadExecutor()</code> and you see weird task rejections then thereâ€™s a good chance you hit the same problem!</li>
</ol>

<p><img src="/images/posts/2021/single-thread-executors.jpg" alt="Some funny meme" /></p>

  </div><a class="u-url" href="/blog/not-all-java-single-threaded-executors-are-created-equal-a-java-finalizer-horror-story/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Julien Ponge</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Julien Ponge</li><li><a class="u-email" href="mailto:julien@ponge.org">julien@ponge.org</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jponge"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jponge</span></a></li><li><a href="https://www.linkedin.com/in/JulienPonge"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">JulienPonge</span></a></li><li><a href="https://www.twitter.com/jponge"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jponge</span></a></li><li><a href="/feed.xml"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg> <span>rss</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
